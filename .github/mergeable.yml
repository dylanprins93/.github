version: 2
mergeable:

#########################
### Naming convention ###
#########################
- when: pull_request.*, pull_request_review.*
  name: 'Naming convention'
  filter:
    - do: repository
      visibility: 'private'
      name:
        must_exclude:
          regex: '^(InSpark\.|Solution\.|BRC\.|DNA\.|DEV\.|SEC\.|.github$)'
  validate:
    - do: age
      created_at:
        days: 0
  pass:
    - do: checks 
      status: 'failure' 
      payload:
        title: 'Naming convention'
        summary: 'The repo is not following the naming convention'

##############
### Global ###
##############

- when: pull_request.*, pull_request_review.*
  name: 'Default rules'
  validate:
    - do: baseRef
      must_exclude:
        regex: 'master'
        message: 'Merging into repo:master is forbidden'
  pass:
    - do: checks 
      status: 'success' 
      payload:
        title: 'Mergeable Run have been Completed!'
        summary: "All the validators have returned 'pass'! \n Here are some stats of the run: \n {{validationCount}} validations were ran"

- when: pull_request.*, pull_request_review.*
  filter:
    - do: repository
      visibility: 'private'
  validate:
    - do: age
      created_at:
        days: 0
  pass:
    - do: assign
      assignees: ['@author']

- when: pull_request.*, pull_request_review.*
  name: 'Default private rules'
  filter:
    - do: repository
      visibility: 'private'
      name:
        must_include:
          regex: 'Solution.'
  validate:
    - do: approvals
      min:
        count: 2
        message: 'Custom message...'
      required:
        owners: true
        assignees: false
        requested_reviewers: false
        message: 'Custom message...'
      block:
        changes_requested: true
        message: 'Custom message...'
      limit:
        owners: true
  pass:
    - do: checks 
      status: 'success' 
      payload:
        title: 'Mergeable Run have been Completed!'
        summary: "All the validators have returned 'pass'! \n Here are some stats of the run: \n {{validationCount}} validations were ran"
  fail:
    - do: checks # default fail case
      status: 'failure' # Can be: success, failure, neutral, cancelled, timed_out, or action_required
      payload:
        title: 'Mergeable Run have been Completed!'
        summary: |
            ### Status: {{toUpperCase validationStatus}}
                  Here are some stats of the run:
                  {{validationCount}} validations were ran.
                  {{passCount}} PASSED
                  {{failCount}} FAILED
        text: "{{#each validationSuites}}\n
              #### {{{statusIcon status}}} Validator: {{toUpperCase name}}\n
              {{#each validations }} * {{{statusIcon status}}} ***{{{ description }}}***\n
                    Input : {{{details.input}}}\n
                    Settings : {{{displaySettings details.settings}}}\n
                    {{/each}}\n
              {{/each}}"

#################
### SOLUTIONS ###
#################

- when: pull_request.*, pull_request_review.*
  name: 'Check labels'
  filter:
    - do: repository
      visibility: 'private' # Can be public or private
      name:
        must_include:
          regex: 'Solution.'
  validate:
    - do: label
      must_include:
        regex: 'patch|minor|major|no-release'
        regex_flag: 'none'
        message: 'Must have a version increment label'
  fail:
    - do: checks 
      status: 'failure' 
      payload:
        title: 'Must have a version increment or no-release label'
        summary: |
            ### Status: {{toUpperCase validationStatus}}
                  Here are some stats of the run:
                  {{validationCount}} validations were ran.
                  {{passCount}} PASSED
                  {{failCount}} FAILED
        text: "{{#each validationSuites}}\n
              #### {{{statusIcon status}}} Validator: {{toUpperCase name}}\n
              {{#each validations }} * {{{statusIcon status}}} ***{{{ description }}}***\n
                    Input : {{{details.input}}}\n
                    Settings : {{{displaySettings details.settings}}}\n
                    {{/each}}\n
              {{/each}}"
- when: pull_request.*, pull_request_review.*
  name: 'Check approvals'
  filter:
    - do: repository
      visibility: 'private'
      name:
        must_include:
          regex: 'Solution.'
  validate:
    - do: approvals
      min:
        count: 2
        message: 'Custom message...'
      required:
        owners: true
        assignees: false
        requested_reviewers: false
        message: 'Custom message...'
      block:
        changes_requested: true
        message: 'Custom message...'
      limit:
        owners: true
  pass:
    - do: checks 
      status: 'success' 
      payload:
        title: 'Mergeable Run have been Completed!'
        summary: "All the validators have returned 'pass'! \n Here are some stats of the run: \n {{validationCount}} validations were ran"
